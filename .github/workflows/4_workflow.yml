name: Workflow 4

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/github-oicd
          aws-region: ${{ vars.AWS_REGION }}
      
  
      # 4. Pacotar os Helm charts
      - name: Pacotar Helm charts
        run: |
          mkdir -p packaged-charts
          for dir in */ ; do
            if [ -f "$dir/Chart.yaml" ]; then
              helm package "$dir" --destination packaged-charts
            fi
          done

      # 5. Instalar e Usar o Plugin helm-s3 no Mesmo Step
      - name: Inicializar e Atualizar Repositório Helm no S3
        run: |
          # Instalar o plugin helm-s3
          helm plugin install https://github.com/hypnoglow/helm-s3.git

          # Verificar se o plugin foi instalado
          helm plugin list

          # Inicializar o repositório Helm no S3 (somente na primeira execução)
          # Você pode comentar este comando após a primeira execução para evitar erros
          helm s3 init s3://platos-helm-charts

          # Empurrar os charts para o S3
          for chart in packaged-charts/*.tgz; do
            helm s3 push "$chart" s3://platos-helm-charts
          done
